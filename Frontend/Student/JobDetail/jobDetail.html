<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<style>
    body {
        font-family: Arial, sans-serif;
        padding: 24px;
        background: #f5f7fb
    }

    .wrap {
        max-width: 900px;
        margin: 0 auto;
    }

    .card {
        background: #ffffff;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 1px 6px rgba(0, 0, 0, 0.06);
    }

    h1 {
        margin-top: 0
    }

    ul {
        margin-top: 8px
    }

    .back {
        margin-bottom: 12px
    }

    .btn-apply {
        background: #29c951;
        color: #fff;
        border: none;
        border-radius: 6px;
        padding: 8px 12px;
        cursor: pointer;
    }

    .meta {
        color: #666;
        margin-bottom: 12px;
    }

    .muted {
        color: #888;
        font-size: 14px;
    }
</style>

<body>
    <div>
        <div id="job" class="card"></div>
    </div>
    <script>
        //lấy jobId từ local storage
        function getSelectedJobId() {
            const id = localStorage.getItem('selected_job_id');
            return id ? String(id) : null;
        }
        //lưu lại jobId vào local storage
        function saveSelectedJobId(id) {
            try {
                if (id == null) return;
                localStorage.setItem('selected_job_id', String(id));
            } catch (error) {
                console.warn('local storage is not available: ', error);
            }
        }
        //lấy dữ liệu từ file json
        async function fetchJobs(path = '../../../json/jobs-data.json') {
            try {
                const res = await fetch(path, { cache: 'no-cache' });
                if (!res.ok) throw new Error('Fetch failed ' + res.status);
                const data = await res.json();
                return Array.isArray(data) ? data : (Array.isArray(data.jobs) ? data.jobs : []);
            } catch (err) {
                console.error(err);
                return [];
            }
        }


        function findJobById(jobs, id) {
            if (!id || !Array.isArray(jobs)) return null;
            const idStr = String(id);
            return jobs.find(j => String(j.jobId ?? j.jobID ?? j.id ?? '') === idStr) || null;
        }

        function arrayToListHtml(arr) {
            if (!arr || arr.length === 0) return '<li class="muted">Không có</li>';
            return arr.map(x => `<li>${escapeHtml(String(x))}</li>`).join('');
        }

        function formatSalary(s) {
            if (!s) return 'Thương lượng';
            if (typeof s === 'string') return s;
            const min = s.min ?? s.from ?? null;
            const max = s.max ?? s.to ?? null;
            const cur = s.currency ? ' ' + s.currency : '';
            if (min == null && max == null) return 'Thương lượng';
            if (min != null && max != null) return `${Number(min).toLocaleString()} - ${Number(max).toLocaleString()}${cur}`;
            return `${Number(min ?? max).toLocaleString()}${cur}`;
        }

        function renderJobDetail(job) {
            const c = document.getElementById('job');
            if (!job) {
                c.innerHTML = `<h1>Không tìm thấy công việc</h1><p class="muted">Hãy quay lại trang danh sách và thử lại.</p><div style="margin-top:16px"><button onclick="history.back()" class="btn-apply">Quay lại</button></div>`;
                return;
            }
            const salaryStr = formatSalary(job.salary);
            const reqs = Array.isArray(job.requirement) ? job.requirement : (job.requirement ? [job.requirement] : []);
            const bens = Array.isArray(job.benefit) ? job.benefit : (job.benefit ? [job.benefit] : []);
            const desc = job.description ? escapeHtml(job.description) : 'Không có mô tả.';
            c.innerHTML = `
        <div class="back"><button onclick="history.back()" class="btn-apply" style="background:#2d9cff;margin-bottom:10px">← Quay lại</button></div>
        <h1>${escapeHtml(job.jobTitle ?? job.title ?? 'Không có tiêu đề')}</h1>
        <div class="meta">${escapeHtml(job.companyName ?? 'Công ty ẩn danh')} • ${escapeHtml(job.location ?? 'Chưa rõ')} • ${escapeHtml(job.field ?? '')} • ${escapeHtml(salaryStr)}</div>
        <hr/>
        <h3>Mô tả công việc</h3><p>${desc}</p>
        <h3>Yêu cầu</h3><ul>${arrayToListHtml(reqs)}</ul>
        <h3>Quyền lợi</h3><ul>${arrayToListHtml(bens)}</ul>
        <div style="margin-top:16px"><button id="applyBtn" class="btn-apply">Ứng tuyển</button></div>
      `;
            const btn = document.getElementById('applyBtn');
            if (btn) btn.addEventListener('click', () => alert('Demo: bạn đã ấn Ứng tuyển'));
        }

        async function init() {
            const id = getSelectedJobId();
            console.log('DEBUG selected_job_id=', id);
            if (id) saveSelectedJobId(id);

            const jobs = await fetchJobs('jobs-data.json');
            console.log('DEBUG jobs count=', jobs.length);
            if (!jobs.length) {
                document.getElementById('job').innerHTML = '<h2>Không tải được dữ liệu jobs-data.json</h2>';
                return;
            }

            if (!id) {
                renderJobDetail(jobs[0]); // fallback hiển thị job đầu tiên
                return;
            }

            const job = findJobById(jobs, id);
            console.log('DEBUG found job=', job);
            renderJobDetail(job);
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>

</html>